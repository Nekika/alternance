<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Projets annexes - SMC | Suivi d&#39;alternance</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <meta name="description" content="Ce rapport présentera l'institution et le service au sein desquels l'alternance a été réalisée.">
    <link rel="preload" href="/assets/css/0.styles.95c70d13.css" as="style"><link rel="preload" href="/assets/js/app.95b712ba.js" as="script"><link rel="preload" href="/assets/js/2.823c70a3.js" as="script"><link rel="preload" href="/assets/js/3.855c304c.js" as="script"><link rel="prefetch" href="/assets/js/10.bc8f9867.js"><link rel="prefetch" href="/assets/js/11.263d977d.js"><link rel="prefetch" href="/assets/js/12.cef03993.js"><link rel="prefetch" href="/assets/js/13.9fae9039.js"><link rel="prefetch" href="/assets/js/14.3914dd35.js"><link rel="prefetch" href="/assets/js/15.1e34ef7d.js"><link rel="prefetch" href="/assets/js/16.9dc726b6.js"><link rel="prefetch" href="/assets/js/17.2e2d2465.js"><link rel="prefetch" href="/assets/js/18.194d7317.js"><link rel="prefetch" href="/assets/js/19.2aec4bc1.js"><link rel="prefetch" href="/assets/js/20.743472b5.js"><link rel="prefetch" href="/assets/js/21.1ef79ede.js"><link rel="prefetch" href="/assets/js/22.cfa4da44.js"><link rel="prefetch" href="/assets/js/4.871bcf60.js"><link rel="prefetch" href="/assets/js/5.f5201cba.js"><link rel="prefetch" href="/assets/js/6.e842a923.js"><link rel="prefetch" href="/assets/js/7.f6f50e7f.js"><link rel="prefetch" href="/assets/js/8.09563207.js"><link rel="prefetch" href="/assets/js/9.ac035cd6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.95c70d13.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Suivi d'alternance</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Accueil
</a></div><div class="nav-item"><a href="/presentation.html" class="nav-link">
  Présentation
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Prérequis" class="dropdown-title"><span class="title">Prérequis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/prerequis/" class="nav-link">
  À propos
</a></li><li class="dropdown-item"><!----> <a href="/prerequis/qgis.html" class="nav-link">
  QGIS
</a></li><li class="dropdown-item"><!----> <a href="/prerequis/qgis-server.html" class="nav-link">
  QGIS Server
</a></li><li class="dropdown-item"><!----> <a href="/prerequis/lizmap.html" class="nav-link">
  Lizmap
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Projets annexes" class="dropdown-title"><span class="title">Projets annexes</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/projets-annexes/" class="nav-link router-link-active">
  À propos
</a></li><li class="dropdown-item"><!----> <a href="/projets-annexes/modal.html" class="nav-link">
  Modal
</a></li><li class="dropdown-item"><!----> <a href="/projets-annexes/smc.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  SMC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CartoGIS54" class="dropdown-title"><span class="title">CartoGIS54</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cartogis54/" class="nav-link">
  À propos
</a></li><li class="dropdown-item"><!----> <a href="/cartogis54/client.html" class="nav-link">
  Application client
</a></li><li class="dropdown-item"><!----> <a href="/cartogis54/plugin.html" class="nav-link">
  Plugin QGIS
</a></li><li class="dropdown-item"><!----> <a href="/cartogis54/bourgs-centres.html" class="nav-link">
  Bourgs-Centres
</a></li></ul></div></div><div class="nav-item"><a href="/liens.html" class="nav-link">
  Liens
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Accueil
</a></div><div class="nav-item"><a href="/presentation.html" class="nav-link">
  Présentation
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Prérequis" class="dropdown-title"><span class="title">Prérequis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/prerequis/" class="nav-link">
  À propos
</a></li><li class="dropdown-item"><!----> <a href="/prerequis/qgis.html" class="nav-link">
  QGIS
</a></li><li class="dropdown-item"><!----> <a href="/prerequis/qgis-server.html" class="nav-link">
  QGIS Server
</a></li><li class="dropdown-item"><!----> <a href="/prerequis/lizmap.html" class="nav-link">
  Lizmap
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Projets annexes" class="dropdown-title"><span class="title">Projets annexes</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/projets-annexes/" class="nav-link router-link-active">
  À propos
</a></li><li class="dropdown-item"><!----> <a href="/projets-annexes/modal.html" class="nav-link">
  Modal
</a></li><li class="dropdown-item"><!----> <a href="/projets-annexes/smc.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  SMC
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CartoGIS54" class="dropdown-title"><span class="title">CartoGIS54</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cartogis54/" class="nav-link">
  À propos
</a></li><li class="dropdown-item"><!----> <a href="/cartogis54/client.html" class="nav-link">
  Application client
</a></li><li class="dropdown-item"><!----> <a href="/cartogis54/plugin.html" class="nav-link">
  Plugin QGIS
</a></li><li class="dropdown-item"><!----> <a href="/cartogis54/bourgs-centres.html" class="nav-link">
  Bourgs-Centres
</a></li></ul></div></div><div class="nav-item"><a href="/liens.html" class="nav-link">
  Liens
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Projets annexes - SMC</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/projets-annexes/smc.html#introduction" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/projets-annexes/smc.html#analyse" class="sidebar-link">Analyse</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/projets-annexes/smc.html#integration-d-un-plugin" class="sidebar-link">Intégration d'un plugin</a></li><li class="sidebar-sub-header"><a href="/projets-annexes/smc.html#developpement-d-un-plugin" class="sidebar-link">Développement d'un plugin</a></li><li class="sidebar-sub-header"><a href="/projets-annexes/smc.html#besoin" class="sidebar-link">Besoin</a></li></ul></li><li><a href="/projets-annexes/smc.html#solution-proposee" class="sidebar-link">Solution proposée</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/projets-annexes/smc.html#premiere-version" class="sidebar-link">Première version</a></li><li class="sidebar-sub-header"><a href="/projets-annexes/smc.html#retour-utilisateur" class="sidebar-link">Retour utilisateur</a></li><li class="sidebar-sub-header"><a href="/projets-annexes/smc.html#deuxieme-version" class="sidebar-link">Deuxième version</a></li></ul></li><li><a href="/projets-annexes/smc.html#conclusion" class="sidebar-link">Conclusion</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/projets-annexes/smc.html#utilisation-d-api" class="sidebar-link">Utilisation d'API</a></li><li class="sidebar-sub-header"><a href="/projets-annexes/smc.html#l-importance-du-retour-utilisateur" class="sidebar-link">L'importance du retour utilisateur</a></li><li class="sidebar-sub-header"><a href="/projets-annexes/smc.html#etat-d-avancement" class="sidebar-link">Etat d'avancement</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="smc-selection-multi-couches"><a href="#smc-selection-multi-couches" class="header-anchor">#</a> SMC (Sélection Multi Couches)</h1> <p><img src="/assets/img/icon.42297858.png" alt="icon-smc"></p> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>J'ai été chargé de créer un <strong>plugin</strong> pour QGIS, permettant de <strong>sélectionner d'un seul coup toutes les entités visibles dans l'interface, et ceux pour toutes les couches du projet</strong>.</p> <div class="custom-block tip"><p class="custom-block-title">Informations</p> <p><strong>Contexte</strong> : Le logiciel QGIS est utilisé par les géomaticiens et les agents de terrain chargés de collecter des données à travers le département de Meurthe-et-Moselle.</p> <p><strong>Problème</strong> : N'ayant pas de connexion internet sur le terrain, les agents n'ont donc pas accès aux bases de données. Il sont alors contraints de sauvegader les données sur leur ordinateur portable avant de partir. Cette tâche est fastidieuse puisqu'ils doivent sélectionner manuellement chaque entité qu'ils souhaient sauvegarder en cliquant dessus. Cela devient très pénible pour des projets de grande envergure.</p> <p><strong>Objectif</strong> : Développer un plugin QGIS permettant la sélection de toutes les entités présentes dans l'emprise définie par l'utilisateur.</p> <p><strong>Technologie utilisée</strong> : Python</p></div> <h2 id="analyse"><a href="#analyse" class="header-anchor">#</a> Analyse</h2> <p>Ma mission consistant à <strong>développer un plugin</strong>, j'ai donc commencé par prendre le temps de <strong>chercher des informations</strong> et de lire la <a href="https://docs.qgis.org/3.10/fr/docs/index.html" target="_blank" rel="noopener noreferrer">documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> avant <strong>d'analyser le besoin</strong>.</p> <h3 id="integration-d-un-plugin"><a href="#integration-d-un-plugin" class="header-anchor">#</a> Intégration d'un plugin</h3> <p>Afin d'intégrer un <strong>plugin local</strong>, QGIS nous propose de placer notre code dans un répertoire qu'il viendra <strong>scanner au démarrage</strong> :</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># Exemple de structure de fichiers</span>

-- <span class="token variable">$REPERTOIRE_QGIS</span>
  <span class="token operator">|</span>-- profiles/
    <span class="token operator">|</span>-- default/
      <span class="token operator">|</span>-- python/
        <span class="token operator">|</span>-- plugins/
    <span class="token operator">|</span>-- mon_profil/
      <span class="token operator">|</span>-- python/
        <span class="token operator">|</span>-- plugins/
</code></pre></div><ul><li><p><code>profiles/</code> : le répertoire qui stocke les différents profils utilisateurs.</p></li> <li><p><code>profiles/*/python/plugins</code> : le sous-répertoire scanné par QGIS, dans lequel on peut retrouver le code source des extensions.</p></li></ul> <div class="custom-block warning"><p class="custom-block-title">Note</p> <p>Le répertoire <code>profiles/default</code> permet de définir des configurations qui seront appliqués à l'utilisateur par défaut <strong>ET</strong> à tous les utilisateurs.</p> <p>Ainsi, dans le répertoire <code>profiles/default/python/plugins</code> on pourra retrouver des extensions disponibles pour tous les utilisateurs tandis que le répertoire <code>profiles/mon_profil/python/plugins</code> contiendra des extentions destinées à l'utilisateur <em>mon_profil</em> <strong>uniquement</strong>.</p></div> <h3 id="developpement-d-un-plugin"><a href="#developpement-d-un-plugin" class="header-anchor">#</a> Développement d'un plugin</h3> <p>Pour le développement de plugins, QGIS encourage l'utilisation de <strong>Python</strong> plutôt que C++.</p> <p>Ainsi, sur la documentation officielle de QGIS, on peut retrouver le <a href="https://docs.qgis.org/3.10/en/docs/pyqgis_developer_cookbook/index.html" target="_blank" rel="noopener noreferrer">PyQGIS Developer Cookbook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> qui explique de manière détaillée la marche à suivre pour créer un plugin en utilisant <a href="https://qgis.org/pyqgis/3.0/" target="_blank" rel="noopener noreferrer">l'API Python<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h4 id="structure-d-un-plugin"><a href="#structure-d-un-plugin" class="header-anchor">#</a> Structure d'un plugin</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># Structure minimale</span>

-- <span class="token variable">$REPERTOIRE_QGIS_PLUGINS</span>
  <span class="token operator">|</span>-- mon_super_plugin/
    <span class="token operator">|</span>-- __init__.py
    <span class="token operator">|</span>-- form.ui
    <span class="token operator">|</span>-- form.py
    <span class="token operator">|</span>-- metadata.txt
    <span class="token operator">|</span>-- mon_super_plugin.py
    <span class="token operator">|</span>-- resources.py
    <span class="token operator">|</span>-- resources.qrc
</code></pre></div><ul><li><p><code>__init__.py</code> : le point d'entrée du plugin.</p></li> <li><p><code>form.ui</code> : l'interface utilisateur que l'on peut éditer avec <a href="https://doc.qt.io/qt-5/qtdesigner-manual.html" target="_blank" rel="noopener noreferrer">Qt Designer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p></li> <li><p><code>form.py</code> : une classe réprésentant l'interface utilisateur du plugin, basée sur le contenu du fichier <code>form.ui</code>.</p></li> <li><p><code>metadata.txt</code> : les métadonnées relatives au plugin.</p></li> <li><p><code>mon_super_plugin.py</code> : le code source du plugin.</p></li> <li><p><code>resources.py</code> : la version compilée en Python de <code>resources.qrc</code></p></li> <li><p><code>resources.qrc</code> : un fichier au format XML créé par <a href="https://doc.qt.io/qt-5/qtdesigner-manual.html" target="_blank" rel="noopener noreferrer">Qt Designer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> et contenant des informations relatives à l'interface utilisateur.</p></li></ul> <p>Ces fichiers composent le <strong>squelette de base</strong> d'un plugin QGIS.</p> <p>Pour un plugin d'une <strong>plus grande ampleur</strong> il est possible de se retrouver avec des architectures telles que celle-ci :</p> <p>Dans notre cas, une <strong>structure simple</strong> telle que celle ci-dessus suffira puisque le plugin ne contiendra que <strong>quelques instructions</strong>.</p> <h3 id="besoin"><a href="#besoin" class="header-anchor">#</a> Besoin</h3> <p>Il faut permettre à l'utilisateur de <strong>gagner du temps</strong> en obtenant <strong>immédiatement</strong> une sélection de <strong>toutes les entités</strong> présentes dans l'emprise, tout en effectuant <strong>le moins d'action possible</strong>.</p> <h2 id="solution-proposee"><a href="#solution-proposee" class="header-anchor">#</a> Solution proposée</h2> <p>Il s'avère qu'au cours de mes quelques mois au sein du service SIG, j'ai eu l'occasion de travaillé deux fois sur ce projet.</p> <p>En effet, au mois d'octobre j'ai développé et livré une première version de l'outil afin de répondre au besoin primaire des utilisateurs.</p> <p>Bien que cette solution ait fait l'affaire pendant quelques mois, avant et après la période de confinement causée par la crise sanitaire du COVID-19, les utilisateurs m'ont remonté des idées d'amélioration au mois de juillet.</p> <p>Je me suis donc chargé de développer une nouvelle version du plugin afin de répondre aux nouveaux besoins des utilisateurs.</p> <h3 id="premiere-version"><a href="#premiere-version" class="header-anchor">#</a> Première version</h3> <p>L'idée est de fournir un outil capable d'effectuer la sélection <strong>en un seul clic</strong> :</p> <p><img src="/assets/img/v1-preview.70f7ddba.gif" alt="SMC v1 preview"></p> <div class="custom-block warning"><p class="custom-block-title">Note</p> <p>Les utilisateurs finaux sélectionnent les entités de toutes les couches du projet, sauf une (la couche <em>Communes</em>).</p> <p>Il n'était alors pas nécessaire de fournir une interface utilisateur permettant de sélectionner les couches sur lesquelles effectuer la sélection.</p></div> <h4 id="structure"><a href="#structure" class="header-anchor">#</a> Structure</h4> <p>L'architecture est très <strong>simplifiée</strong> puisque d'une part il n'y a que quelques instructions à fournir, et d'autre part il n'y a pas besoin d'interface utilisateur :</p> <div class="language-shell extra-class"><pre class="language-shell"><code>-- <span class="token variable">$REPERTOIRE_QGIS_PLUGINS</span>
  <span class="token operator">|</span>-- SMC/
    <span class="token operator">|</span>-- __init.py__
    <span class="token operator">|</span>-- icon.png
    <span class="token operator">|</span>-- metadata.txt
    <span class="token operator">|</span>-- pb_tool.cfg
    <span class="token operator">|</span>-- smc.py
    <span class="token operator">|</span>-- README.md
    <span class="token operator">|</span>-- resources.py
    <span class="token operator">|</span>-- resources.qrc
    <span class="token operator">|</span>-- tools.py
</code></pre></div><p>On remarque tout de même la présence de nouveaux fichiers :</p> <ul><li><p><code>icon.png</code> : l'icone qui représente le plugin dans l'interface de QGIS.</p></li> <li><p><code>pb_tool.cfg</code> : un outil permettant de compiler le plugin, voir <a href="http://g-sherman.github.io/plugin_build_tool/" target="_blank" rel="noopener noreferrer">Plugin Builder Tool<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p></li> <li><p><code>tools.py</code> : des fonctions dont la présence au sein du coeur du plugin n'était pas pertinente.</p></li></ul> <h4 id="code"><a href="#code" class="header-anchor">#</a> Code</h4> <p>L'utilisation de <a href="https://qgis.org/pyqgis/3.0/" target="_blank" rel="noopener noreferrer">l'API Python<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> de QGIS rend le code <strong>simple à lire et à comprendre</strong> même pour quelqu'un n'ayant jamais manipuler Python. Je vais donc me permettre de détailler le fonctionnement du plugin.</p> <p>Le <strong>fichier principal</strong> ( <code>smc.py</code> ) est une classe qui doit implémenter des <strong>méthodes définies par l'API</strong>.</p> <p>Ces méthodes servent à <strong>configurer</strong> le plugin lors du démarrage de QGIS. Elles sont donc <strong>indispensables</strong>.</p> <div class="custom-block warning"><p class="custom-block-title">Note</p> <p>L'idée n'étant pas d'expliquer les mécanismes derrière le fonctionnement global d'un plugin, je me contenterai d'expliquer ce que j'ai développé.</p> <p>Pour plus de détail sur ces méthodes ou sur le fonctionnement des plugins, se référer au <a href="https://docs.qgis.org/3.10/en/docs/pyqgis_developer_cookbook/plugins/plugins.html#writing-a-plugin" target="_blank" rel="noopener noreferrer">PyQGIS Developer Cookbook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p></div> <p>Parmi les méthodes <strong>indispensables</strong>, on peut retrouver <code>run()</code>.</p> <p>C'est elle qui sera appelée lorsque l'utilisateur souhaite se servir du plugin, c'est donc à l'intérieur que l'on va indiquer les <strong>actions à effectuer</strong> :</p> <p><strong><code>smc.py</code></strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
  layers <span class="token operator">=</span> get_all_vectorLayers<span class="token punctuation">(</span><span class="token punctuation">)</span>
  extent <span class="token operator">=</span> self<span class="token punctuation">.</span>get_extent<span class="token punctuation">(</span><span class="token punctuation">)</span>
  select_features_in_area<span class="token punctuation">(</span>layers<span class="token punctuation">,</span> extent<span class="token punctuation">)</span>
</code></pre></div><p>On remarque que cette méthode fait appel à <strong>2 fonctions</strong> et <strong>une autre méthode</strong> :</p> <ul><li><code>get_all_vectorLayers()</code></li></ul> <p>Cette fonction permet de <strong>récupérer la liste des couches vectorielles</strong> du projet puisque c'est sur celles-ci que sont représentées les entités à sélectionner :</p> <p><strong><code>tools.py</code></strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_all_vectorLayers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    layers <span class="token operator">=</span> QgsProject<span class="token punctuation">.</span>instance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mapLayers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> layer <span class="token keyword">in</span> layers<span class="token punctuation">:</span>
        <span class="token keyword">if</span> layer<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> layer<span class="token punctuation">.</span>name<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">&quot;Communes&quot;</span><span class="token punctuation">:</span>
            res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>layer<span class="token punctuation">)</span>
    <span class="token keyword">return</span> res
</code></pre></div><p>En se référant à la classe <a href="https://qgis.org/pyqgis/master/core/QgsMapLayer.html" target="_blank" rel="noopener noreferrer">QgsMapLayer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, on découvre que la méthode <code>type()</code> nous offre le moyen de <strong>connaître le type de la couche</strong> :</p> <ul><li><p><strong>VectorLayer</strong> : 0</p></li> <li><p><strong>RasterLayer</strong> : 1</p></li> <li><p><strong>PluginLayer</strong> : 2</p></li> <li><p><strong>MeshLayer</strong> : 3</p></li> <li><p><strong>VectorTileLayer</strong> : 4</p></li></ul> <p>La condition <code>if layer.type() == 0 and layer.name() != &quot;Communes&quot;:</code> permet donc de s'assurer d'une part que la couche traitée est bel et bien de <strong>type vectoriel</strong>, et d'autre par que la couche traitée n'est pas la couche <em>Communes</em>.</p> <ul><li><code>get_extent()</code></li></ul> <p>C'est la méthode qui va permettre de <strong>récupérer les coordonnées de l'emprise</strong> réglée par l'utilisateur :</p> <p><strong><code>smc.py</code></strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_extent</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
  mapcanvas <span class="token operator">=</span> self<span class="token punctuation">.</span>iface<span class="token punctuation">.</span>mapCanvas<span class="token punctuation">(</span><span class="token punctuation">)</span>
  extent <span class="token operator">=</span> mapcanvas<span class="token punctuation">.</span>extent<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> extent
</code></pre></div><p>La méthode se contente de <strong>récupérer l'instance de <a href="https://qgis.org/pyqgis/master/gui/QgsMapCanvas.html" target="_blank" rel="noopener noreferrer">MapCanvas<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong> et d'utiliser la méthode <code>extent()</code> pour pouvoir <strong>récupérer les coordonées</strong> de l'emprise.</p> <ul><li><code>select_features_in_area()</code></li></ul> <p>Les tâches effectuées en amont ayant permis de récupérer des données qui sont nécessaires pour pouvoir répondre au besoin, cette dernière fonction va se charger <strong>d'effectuer la sélection</strong> de toutes les entités présentes dans l'emprise :</p> <p><strong><code>smc.py</code></strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">select_features_in_area</span><span class="token punctuation">(</span>layers<span class="token punctuation">,</span> area<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">for</span> layer <span class="token keyword">in</span> layers<span class="token punctuation">:</span>
    layer<span class="token punctuation">.</span>selectByRect<span class="token punctuation">(</span>area<span class="token punctuation">)</span>
</code></pre></div><p>Cette fonction très simple fait appel à la méthode <code>selectByRect</code> de la classe <a href="https://qgis.org/pyqgis/master/core/QgsVectorLayer.html#qgis.core.QgsVectorLayer.selectByRect" target="_blank" rel="noopener noreferrer">QgsVectorLayer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> et elle permet, à partir d'une couche vectorielle, de <strong>sélectionner toutes les entités contenues au sein d'un rectangle</strong>.</p> <p>Dans notre cas, le rectangle n'est autre que <strong>l'emprise</strong> réglée par l'utilisateur.</p> <h3 id="retour-utilisateur"><a href="#retour-utilisateur" class="header-anchor">#</a> Retour utilisateur</h3> <p>Après <strong>quelques mois d'utilisation</strong>, les utilisateurs m'ont fait quelques <strong>retours constructifs</strong> quant à <strong>l'utilisation réelle</strong> de l'extension.</p> <h4 id="point-positif"><a href="#point-positif" class="header-anchor">#</a> Point positif</h4> <p>L'extension <strong>répond parfaitement au besoin primaire</strong> des utilisateurs et leur permet de <strong>gagner un temps précieux</strong>.</p> <h4 id="points-negatifs"><a href="#points-negatifs" class="header-anchor">#</a> Points négatifs</h4> <ul><li><strong>Sélection trop importante</strong> : la plupart du temps, les utilisateurs ne souhaitent sélectionner des entités qu'au sein d'une, deux voir trois communes. La sélection rectangulaire englobe donc un grand nombre d'entités inutiles.</li> <li><strong>Fonds de plans</strong> : il peut arriver que les utilisateurs aient besoin de sélectionner les fonds de plans. Or, dans la version actuelle du plugin il est impossible de le faire.</li></ul> <h3 id="deuxieme-version"><a href="#deuxieme-version" class="header-anchor">#</a> Deuxième version</h3> <p>Afin de répondre aux <strong>nouveaux besoins</strong> des utilisateurs, il a été nécessaire de <strong>repenser totalement</strong> l'utilisation du plugin.</p> <p>Très vite, la nécessité de fournir une <strong>interface homme-machine</strong> est apparue, car les nouvelles fonctionnalités à implémenter nécessecitent obligatoirement des <strong>actions de la part de l'utilisateur</strong>.</p> <p>Bien que le fonctionnement de l'extension soit <strong>plus complexe</strong>, l'idée derrière reste <strong>similaire</strong> à celle de la première version :</p> <ol><li><strong>Emprise</strong> : L'utilisateur règle l'emprise sur les communes qui l'intéressent.</li> <li><strong>Interface utilisateur</strong> : Au lancement du plugin, une interface utilisateur listant ces communes apparaît.</li> <li><strong>Actions utilisateur</strong> : L'utilisateur peut alors sélectionner les communes sur lesquelles il souhaite effectuer la sélection. Une case à cocher permet d'indiquer à l'extension si elle doit intégrer les fonds de plans dans la sélection.</li> <li><strong>Lancement de la sélection</strong> : Un bouton <em>Valider</em> permet de lancer la sélection.</li></ol> <p><img src="/assets/img/v2-preview.85cd155b.gif" alt="SMC v2 preview"></p> <h4 id="structure-2"><a href="#structure-2" class="header-anchor">#</a> Structure</h4> <hr> <p>Au niveau de l'organisation, cette nouvelle version a nécessité l'ajout de <strong>nouveaux éléments</strong> :</p> <div class="language-shell extra-class"><pre class="language-shell"><code>-- <span class="token variable">$REPERTOIRE_QGIS_PLUGINS</span>
  <span class="token operator">|</span>-- SMC/
    <span class="token operator">|</span>-- utils/
      <span class="token operator">|</span>-- __init.py__
      <span class="token operator">|</span>-- ui.py
    <span class="token operator">|</span>-- README.md
    <span class="token operator">|</span>-- __init.py__
    <span class="token operator">|</span>-- icon.png
    <span class="token operator">|</span>-- metadata.txt
    <span class="token operator">|</span>-- pb_tool.cfg
    <span class="token operator">|</span>-- resources.py
    <span class="token operator">|</span>-- resources.qrc
    <span class="token operator">|</span>-- smc.py
    <span class="token operator">|</span>-- smc_dialog.py
    <span class="token operator">|</span>-- smc_dialog_base.ui
</code></pre></div><ul><li><code>smc_dialog_base.ui</code> : la structure de l'interface utilisateur.</li> <li><code>smc_dialog.py</code> : la classe représentant l'interface utilisateur.</li> <li><code>utils/ui.py</code> : un ensemble de fonctions facilitant la manipulation de l'interface utilisateur lors de l'execution du plugin.</li></ul> <p>La <strong>majorité du fonctionnement</strong> de l'extension se trouve toujours au sein du fichier <code>smc.py</code>.</p> <h4 id="code-2"><a href="#code-2" class="header-anchor">#</a> Code</h4> <hr> <p>Nous nous contenterons ici de présenter les <strong>différences majeures</strong> entre les deux versions, n'hésitez donc pas à revoir <a href="/projets-annexes/smc.html#code">les extraits de code</a> de la première version.</p> <p><strong>Interface utilisateur</strong></p> <p>La plus grande différence est l'apparition d'une interface utilisateur au moment où le plugin est lancé. Son rôle est de permettre l'interaction entre l'utilisateur et l'extension.</p> <p>Afin de rendre cette interaction possible, j'ai eu recours à <a href="https://doc.qt.io/qtforpython/" target="_blank" rel="noopener noreferrer">PyQt<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (la version Python de <a href="https://qt.io" target="_blank" rel="noopener noreferrer">Qt<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> - <em>un célèbre ensemble de librairies C++</em>).</p> <p><img src="/assets/img/qt.d3ef83eb.png" alt="logo-qt"></p> <p>PyQt étant <strong>nativement intégré</strong> à QGIS, je n'ai pas eu à me soucier de la moindre installation.</p> <p>J'ai commencé par <strong>concevoir l'interface</strong> à l'aide de <a href="https://doc.qt.io/qt-5/qtdesigner-manual.html" target="_blank" rel="noopener noreferrer">Qt Designer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, un logiciel permettant de créer des interfaces utilisateurs composées <strong>d'éléments manipulables à l'aide de Qt</strong> (<a href="https://doc.qt.io/qt-5/qtwidgets-index.html" target="_blank" rel="noopener noreferrer">Qt Widgets<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>).</p> <p><img src="/assets/img/v2-designer.748af71c.png" alt="SMC v2 QtDesigner"></p> <p>L'interface utilisateur est composée d'une <strong>table</strong> (<a href="https://doc.qt.io/qtforpython/PySide2/QtWidgets/QTableWidget.html" target="_blank" rel="noopener noreferrer">QTableWidget<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) dans laquelle seront listées les <strong>communes visibles dans l'emprise</strong>, d'une <strong>case à cocher</strong> (<a href="https://doc.qt.io/qtforpython/PySide2/QtWidgets/QCheckBox.html" target="_blank" rel="noopener noreferrer">QCheckBox<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) permettant d'indiquer s'il faut <strong>inclure les fonds de plans</strong> ainsi que d'un <strong>boutton</strong> <em>Valider</em> pour <strong>lancer la sélection</strong> et un <strong>boutton</strong> <em>Annuler</em> pour <strong>fermer la fenêtre</strong> (<a href="https://doc.qt.io/qtforpython/PySide2/QtWidgets/QPushButton.html" target="_blank" rel="noopener noreferrer">QPushButton<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>).</p> <p>Au sein du fichier <code>utils/ui.py</code>, on peut retrouver des fonctions qui aideront à créer les éléments à insérer dans la <strong>table</strong> :</p> <p><strong><code>utils/ui.py</code></strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> qgis<span class="token punctuation">.</span>PyQt<span class="token punctuation">.</span>QtWidgets <span class="token keyword">import</span> QTableWidgetItem
<span class="token keyword">from</span> qgis<span class="token punctuation">.</span>PyQt<span class="token punctuation">.</span>QtCore <span class="token keyword">import</span> Qt

<span class="token keyword">def</span> <span class="token function">create_label</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    item <span class="token operator">=</span> QTableWidgetItem<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    item<span class="token punctuation">.</span>setFlags<span class="token punctuation">(</span>Qt<span class="token punctuation">.</span>NoItemFlags<span class="token punctuation">)</span>
    item<span class="token punctuation">.</span>setTextAlignment<span class="token punctuation">(</span>Qt<span class="token punctuation">.</span>AlignCenter<span class="token punctuation">)</span>
    <span class="token keyword">return</span> item

<span class="token keyword">def</span> <span class="token function">create_checkbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    item <span class="token operator">=</span> QTableWidgetItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
    item<span class="token punctuation">.</span>setFlags<span class="token punctuation">(</span>Qt<span class="token punctuation">.</span>ItemIsUserCheckable <span class="token operator">|</span> Qt<span class="token punctuation">.</span>ItemIsEnabled<span class="token punctuation">)</span>
    item<span class="token punctuation">.</span>setCheckState<span class="token punctuation">(</span>Qt<span class="token punctuation">.</span>Unchecked<span class="token punctuation">)</span>
    <span class="token keyword">return</span> item

<span class="token keyword">def</span> <span class="token function">create_rows</span><span class="token punctuation">(</span>communes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rows <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> c <span class="token keyword">in</span> communes<span class="token punctuation">:</span>
        label<span class="token punctuation">,</span> checkbox <span class="token operator">=</span> create_label<span class="token punctuation">(</span>c<span class="token punctuation">.</span>attribute<span class="token punctuation">(</span><span class="token string">&quot;nom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> create_checkbox<span class="token punctuation">(</span><span class="token punctuation">)</span>
        rows<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span>label<span class="token operator">=</span>label<span class="token punctuation">,</span> checkbox<span class="token operator">=</span>checkbox<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> rows
</code></pre></div><ul><li><code>create_label()</code> : crée un objet (<a href="https://doc.qt.io/qtforpython/PySide2/QtWidgets/QTableWidgetItem.html" target="_blank" rel="noopener noreferrer">QTableWidgetItem<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) qui sera utilisé pour afficher le nom d'une commune.</li> <li><code>create_checkbox()</code> : crée un objet (<a href="https://doc.qt.io/qtforpython/PySide2/QtWidgets/QTableWidgetItem.html" target="_blank" rel="noopener noreferrer">QTableWidgetItem<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) qui sera utilisé pour afficher une case à cocher.</li> <li><code>create_rows()</code> : à partir d'une liste de communes, crée une liste d'objets (<a href="https://doc.qt.io/qtforpython/PySide2/QtWidgets/QTableWidgetItem.html" target="_blank" rel="noopener noreferrer">QTableWidgetItem<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) représentant une ligne à insérer dans la table listant les communes.</li></ul> <p>La fonction <code>create_rows()</code> est appelée au sein de la méthode <code>fill_table()</code> :</p> <p><strong><code>smc.py</code></strong></p> <div class="language-python extra-class"><pre class="language-python"><code> <span class="token keyword">def</span> <span class="token function">fill_table</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> communes<span class="token punctuation">)</span><span class="token punctuation">:</span>
      rows<span class="token punctuation">,</span> table <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>ui<span class="token punctuation">.</span>create_rows<span class="token punctuation">(</span>communes<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> k<span class="token punctuation">:</span> k<span class="token punctuation">[</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>dlg<span class="token punctuation">.</span>tw_communes
      table<span class="token punctuation">.</span>setRowCount<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">for</span> index<span class="token punctuation">,</span> row <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">:</span>
          table<span class="token punctuation">.</span>setItem<span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
          table<span class="token punctuation">.</span>setItem<span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token string">&quot;checkbox&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>Voici l'interface telle qu'elle a été proposée puis validée par les utilisateurs :</p> <p><img src="/assets/img/v2-ui.ad24e163.png" alt="SMC v2 UI"></p> <p>Elle répond aux besoins de <strong>simplicité d'utilisation</strong> et de <strong>pertinence de la sélection</strong> puisqu'elle offre aux utilisateurs la possibiltié de <strong>tout configurer</strong> à l'aide de simples <strong>cases à cocher</strong>.</p> <p><strong>Sélection</strong></p> <p>Le traitement de la sélection <strong>diffère légèrement</strong> de la première version pour <strong>deux raisons majeures</strong> :</p> <ol><li><strong>Traitement pré-selection</strong></li></ol> <p>Il est nécessaire de <strong>récupérer</strong> et <strong>prendre en compte les choix de l'utilisateur</strong>.</p> <p>De ce fait, des <strong>étapes supplémentaires</strong> permettant notamment de récupérer la liste des communes sélectionnées ont du être ajoutées :</p> <p><strong><code>smc.py</code></strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">selected_communes_names</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    res<span class="token punctuation">,</span> table <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>dlg<span class="token punctuation">.</span>tw_communes
    <span class="token keyword">for</span> row <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span>rowCount<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        is_selected <span class="token operator">=</span> table<span class="token punctuation">.</span>item<span class="token punctuation">(</span>row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>checkState<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Qt<span class="token punctuation">.</span>Checked
        <span class="token keyword">if</span> is_selected<span class="token punctuation">:</span>
            res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>table<span class="token punctuation">.</span>item<span class="token punctuation">(</span>row<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res

<span class="token keyword">def</span> <span class="token function">selected_communes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> communes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    selected_communes_names <span class="token operator">=</span> self<span class="token punctuation">.</span>selected_communes_names<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>c <span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>communes<span class="token punctuation">.</span>getFeatures<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> c<span class="token punctuation">.</span>attribute<span class="token punctuation">(</span><span class="token string">&quot;nom&quot;</span><span class="token punctuation">)</span> <span class="token keyword">in</span> selected_communes_names<span class="token punctuation">]</span>
</code></pre></div><ul><li><strong><code>selected_communes_names()</code></strong> : se charge de récupérer les noms des communes sélectionnées par l'utilisateur depuis la table listant les communes.</li> <li><strong><code>selected_communes()</code></strong> : se charge de récupérer les entités correspondantes (objets <code>QgsFeature</code>, voir <a href="https://qgis.org/pyqgis/master/core/QgsFeature.html?highlight=qgsfeature#module-QgsFeature" target="_blank" rel="noopener noreferrer">l'API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) depuis une liste de noms de communes.</li></ul> <p>Ce traitement est nécessaire puisque nous allons avoir besoin de la <strong>géométrie des communes choisies</strong> afin d'effectuer la <strong>sélection des entités</strong>.</p> <ol start="2"><li><strong>Méthode de sélection</strong></li></ol> <p>La sélection est gérée par la méthode <code>select()</code> :</p> <p><strong><code>smc.py</code></strong></p> <div class="language-python extra-class"><pre class="language-python"><code> <span class="token keyword">def</span> <span class="token function">select</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> communes<span class="token punctuation">)</span><span class="token punctuation">:</span>
      QApplication<span class="token punctuation">.</span>setOverrideCursor<span class="token punctuation">(</span>Qt<span class="token punctuation">.</span>WaitCursor<span class="token punctuation">)</span>
      layers <span class="token operator">=</span> <span class="token punctuation">[</span>l <span class="token keyword">for</span> l <span class="token keyword">in</span> QgsProject<span class="token punctuation">.</span>instance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mapLayers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> l<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> l<span class="token punctuation">.</span>name<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">&quot;Communes&quot;</span><span class="token punctuation">]</span>
      <span class="token keyword">if</span> self<span class="token punctuation">.</span>dlg<span class="token punctuation">.</span>cb_exclude<span class="token punctuation">.</span>checkState<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Qt<span class="token punctuation">.</span>Checked<span class="token punctuation">:</span>
          root <span class="token operator">=</span> QgsProject<span class="token punctuation">.</span>instance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>layerTreeRoot<span class="token punctuation">(</span><span class="token punctuation">)</span>
          basemaps_nodes <span class="token operator">=</span> root<span class="token punctuation">.</span>findGroup<span class="token punctuation">(</span><span class="token string">&quot;Fonds de plan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>findLayers<span class="token punctuation">(</span><span class="token punctuation">)</span>
          basemaps_layers <span class="token operator">=</span> <span class="token punctuation">[</span>node<span class="token punctuation">.</span>layer<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> node <span class="token keyword">in</span> basemaps_nodes<span class="token punctuation">]</span>
          layers <span class="token operator">=</span> <span class="token punctuation">[</span>l <span class="token keyword">for</span> l <span class="token keyword">in</span> QgsProject<span class="token punctuation">.</span>instance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mapLayers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> l<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> l <span class="token keyword">not</span> <span class="token keyword">in</span> basemaps_layers<span class="token punctuation">]</span>
      <span class="token keyword">for</span> l <span class="token keyword">in</span> layers<span class="token punctuation">:</span>
          <span class="token keyword">for</span> c <span class="token keyword">in</span> self<span class="token punctuation">.</span>selected_communes<span class="token punctuation">(</span>communes<span class="token punctuation">)</span><span class="token punctuation">:</span>
              expression <span class="token operator">=</span> <span class="token string">&quot;within($geometry, geom_from_wkt('{wkt}'))&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>wkt<span class="token operator">=</span>c<span class="token punctuation">.</span>geometry<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>asWkt<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              l<span class="token punctuation">.</span>selectByExpression<span class="token punctuation">(</span>expression<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      QApplication<span class="token punctuation">.</span>restoreOverrideCursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
      self<span class="token punctuation">.</span>dlg<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Dans un premier temps, on souhaite déterminer la <strong>liste des couches</strong> à partir desquelles on va <strong>effectuer la sélection</strong>.</p> <p>On récupère donc la liste de toutes les <strong>couches vectorielles</strong> du projet (à l'exception de la couche <em>Communes</em>), à laquelle on ajoute les couches <em>Fonds de plans</em> si l'utilisateur le désire.</p> <p>Dans un second temps, on entame <strong>la sélection des entités</strong>. On <strong>boucle sur la liste des couches</strong> que l'on vient de déterminer, et pour chacune d'entre elle on <strong>boucle sur la liste des communes</strong> sélectionnées par l'utilisateur.</p> <p>C'est à ce moment que la méthode de sélection est <strong>totalement différente</strong> de celle employée dans la première version de l'extension. En effet, il s'agit cette fois-ci d'une <strong>sélection par expression</strong> (voir la <a href="https://docs.qgis.org/3.10/fr/docs/user_manual/working_with_vector/expression.html?highlight=expression" target="_blank" rel="noopener noreferrer">documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>).</p> <p><em><strong>De manière silmplifiée</strong></em> : pour chaque couche <code>L</code> et pour chaque commune <code>C</code>, on crée une <strong>expression</strong> visant toutes les <strong>entités</strong> de <code>L</code> dont la <strong>géométrie est contenue</strong> au sein de <code>C</code>. On se contente alors <strong>d'ajouter à la sélection</strong> toutes les entités visées.</p> <h2 id="conclusion"><a href="#conclusion" class="header-anchor">#</a> Conclusion</h2> <p>En travaillant à <strong>deux reprises</strong> sur ce projet lors de mon année au sein du service SIG, j'ai pu apprendre <strong>beaucoup de choses</strong>.</p> <h3 id="utilisation-d-api"><a href="#utilisation-d-api" class="header-anchor">#</a> Utilisation d'API</h3> <p>Grâce à l'API de <a href="https://qgis.org/pyqgis/3.0/" target="_blank" rel="noopener noreferrer">PyQGIS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> et l'API de <a href="https://doc.qt.io/qtforpython/" target="_blank" rel="noopener noreferrer">PyQt<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, j'ai été en mesure de développer un plugin simple qui <strong>répond entièrement</strong> aux besoins définis par les utilisateurs.</p> <p>Cependant, le début du développement et la prise en main de <a href="https://qgis.org/pyqgis/3.0/" target="_blank" rel="noopener noreferrer">l'API Python<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> de QGIS s'avéra <strong>assez difficile</strong> puisque mon travail sur la première version de l'extension fut ma <strong>première expérience</strong> avec une <strong>API d'une telle ampleur</strong>.</p> <p>J'ai donc commencé par produire du code qui s'est trouvé être une <strong>mauvaise réecriture</strong> d'outils existants dans l'API.</p> <p>En voyant que je me dirigeais vers un code assez <strong>compliqué à lire et manipuler</strong>, j'ai décidé de prendre du temps pour <strong>analyser la documentation</strong> de l'API. Par chance, elle se trouve être de bonne qualité, ce qui m'a permis d'arriver au résultat présenté.</p> <p>Lors du développement de la deuxième version de l'extension, j'ai alors été capable de <strong>trouver rapidement</strong> les informations que je cherchais, en parcourant la <strong>documentation</strong> des deux API citées précédemment.</p> <p>Ce projet m'aura donc appris à <strong>naviguer dans la documentation d'une API</strong>.</p> <h3 id="l-importance-du-retour-utilisateur"><a href="#l-importance-du-retour-utilisateur" class="header-anchor">#</a> L'importance du retour utilisateur</h3> <p>Le fait d'avoir pu recevoir un <strong>retour constructif</strong> de la part des utilisateurs m'a bien fait comprendre qu'il est <strong>très difficile</strong> de concevoir un produit <strong>comblant les besoins actuels et futurs</strong> de ses utilisateurs.</p> <p>C'est pour cette raison qu'il s'avère nécessaire d'effectuer un <strong>bon travail d'analyse</strong> et de réfléchir aux <strong>potentiels besoins futurs</strong> des utilisateurs avant de commencer le travail de développement.</p> <h3 id="etat-d-avancement"><a href="#etat-d-avancement" class="header-anchor">#</a> Etat d'avancement</h3> <p>Le projet SMC est <strong>terminé</strong> au moment où je rédige ce rapport, puisque l'extension a été <strong>livrée aux utilisateurs finaux</strong>.</p> <p>Ces derniers m'ont affirmé qu'elle <strong>répondait parfaitement à leurs besoins</strong> et que le résultat c<strong>orrespondait à ce qu'ils attendaient</strong>.</p> <p>De plus, l'extension <strong>n'est pas figée</strong> et sera capable de <strong>s'adapter</strong> à une éventuelle évolution du projet.</p> <p>En effet, elle est conçue pour fonctionner même lorsque les utilisateurs auront envie <strong>d'ajouter, supprimer ou bien modifier des couches</strong> au sein du projet.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/projets-annexes/modal.html" class="prev">
        Projets annexes - Modal
      </a></span> <span class="next"><a href="/cartogis54/">
        CartoGIS54 - À propos
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.95b712ba.js" defer></script><script src="/assets/js/2.823c70a3.js" defer></script><script src="/assets/js/3.855c304c.js" defer></script>
  </body>
</html>
